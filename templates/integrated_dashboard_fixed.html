<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CopperFlow Analytics - Real-Time Commodity Trading Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        :root {
            --primary-color: #1a365d;
            --secondary-color: #2d3748;
            --accent-color: #e53e3e;
            --success-color: #38a169;
            --warning-color: #d69e2e;
            --info-color: #3182ce;
            --light-bg: #f7fafc;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --gradient-info: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            color: #2d3748;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: var(--light-bg);
            min-height: calc(100vh - 120px);
            border-radius: 20px 20px 0 0;
            box-shadow: var(--card-shadow);
        }
        
        header {
            background: var(--primary-color);
            color: white;
            padding: 30px 40px;
            box-shadow: var(--card-shadow);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: white;
            border-radius: 12px;
            padding: 8px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 16px 24px;
            cursor: pointer;
            border-radius: 8px;
            background: transparent;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.95em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            text-align: center;
            border: none;
            outline: none;
            position: relative;
            overflow: hidden;
        }
        
        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .tab:hover::before {
            left: 100%;
        }
        
        .tab:hover {
            background: #f7fafc;
            color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .tab.active {
            background: var(--gradient-primary);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
            width: 100%;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .card h2 {
            margin: 0 0 20px 0;
            color: var(--primary-color);
            font-size: 1.5em;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .card h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--gradient-primary);
            margin-right: 12px;
            border-radius: 2px;
        }
        
        .price-display {
            font-size: 3.2em;
            font-weight: 700;
            color: var(--primary-color);
            margin: 20px 0;
            text-align: center;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-card {
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .metric-card h3 {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .metric-card .value {
            font-size: 2.2em;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .metric-card .subtitle {
            opacity: 0.8;
            font-size: 0.85em;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
        }
        
        .chart-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: var(--secondary-color);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .positive { color: var(--success-color); }
        .negative { color: var(--accent-color); }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        
        .data-table th {
            background: var(--light-bg);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 2px solid #e2e8f0;
        }
        
        .data-table td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s ease;
        }
        
        .data-table tr:hover td {
            background: #f7fafc;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-live {
            background: var(--success-color);
            box-shadow: 0 0 8px var(--success-color);
            animation: pulse 2s infinite;
        }
        
        .status-disconnected {
            background: var(--accent-color);
            box-shadow: 0 0 8px var(--accent-color);
        }
        
        .status-reconnecting {
            background: var(--warning-color);
            box-shadow: 0 0 8px var(--warning-color);
            animation: pulse 1s infinite;
        }
        
        .status-error {
            background: var(--accent-color);
            box-shadow: 0 0 8px var(--accent-color);
            animation: none;
        }
        
        .price-flash {
            animation: priceFlash 1s ease-out;
        }
        
        @keyframes priceFlash {
            0% { background-color: rgba(102, 126, 234, 0.3); }
            100% { background-color: transparent; }
        }
        
        .data-update-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: var(--card-shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideInRight 0.3s ease-out;
        }
        
        .trading-alert {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-left: 4px solid var(--accent-color);
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }
        
        .alert-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #fee;
            border-radius: 8px 8px 0 0;
        }
        
        .alert-title {
            font-weight: 600;
            color: var(--accent-color);
        }
        
        .alert-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .alert-message {
            padding: 12px 16px;
            font-weight: 500;
        }
        
        .alert-details {
            padding: 8px 16px 12px;
            font-size: 0.9em;
            color: #666;
            border-top: 1px solid #f0f0f0;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #666;
        }
        
        .websocket-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .websocket-controls button {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }
        
        .websocket-controls button:hover {
            background: #f7fafc;
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 style="margin: 0; font-size: 2.2em; font-weight: 300;">CopperFlow Analytics</h1>
                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 1.1em;">Real-Time Commodity Trading Intelligence Platform</p>
            </div>
            <div style="text-align: right; opacity: 0.8;">
                <div style="font-size: 0.9em;">Live Market Data</div>
                <div style="font-size: 1.2em; font-weight: 500;">{{ copper_price.get('symbol', 'COMEX: HG=F') }}</div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <div class="tab active" data-target="dashboard-tab">Market Overview</div>
            <div class="tab" data-target="market-data-tab">Live Data</div>
            <div class="tab" data-target="analytics-tab">Analytics</div>
            <div class="tab" data-target="monte-carlo-tab">Monte Carlo</div>
            <div class="tab" data-target="correlation-tab">Correlations</div>
            <div class="tab" data-target="news-tab">Market Intelligence</div>
            <div class="tab" data-target="analysis-tab">Trading Signals</div>
        </div>

        <!-- Tab Content -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="card">
                <h2>Live Market Price</h2>
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                    <span class="status-indicator status-live"></span>
                    <span style="font-size: 0.9em; color: #666;">{{ copper_price.get('symbol', 'COMEX: HG=F') }}</span>
                </div>
                <div class="price-display">${{ copper_price.get('price', 'N/A') }}</div>
                <div class="price-change {% if copper_price.get('change_percent', 0)|float > 0 %}positive{% elif copper_price.get('change_percent', 0)|float < 0 %}negative{% endif %}" style="text-align: center; font-size: 1.2em; font-weight: 600; margin-bottom: 30px;">
                    <span class="change-amount">{% if copper_price.get('change', 0)|float > 0 %}+{% endif %} ${{ copper_price.get('change', 0)|float|round(2) }}</span>
                    <span class="change-percent">({% if copper_price.get('change_percent', 0)|float > 0 %}+{% endif %}{{ copper_price.get('change_percent', 0)|float|round(2) }}%)</span>
                </div>
                
                <div class="metric-grid">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 12px;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Daily High</div>
                        <div style="font-size: 1.4em; font-weight: 600; color: var(--success-color);">${{ copper_price.get('high', 'N/A') }}</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 12px;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Daily Low</div>
                        <div style="font-size: 1.4em; font-weight: 600; color: var(--accent-color);">${{ copper_price.get('low', 'N/A') }}</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 12px;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Volume</div>
                        <div style="font-size: 1.4em; font-weight: 600; color: var(--info-color);">{{ copper_price.get('volume', 'N/A') }}</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 12px;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Last Update</div>
                        <div style="font-size: 1em; font-weight: 500; color: #666;">{{ copper_price.get('timestamp', 'N/A') }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Real-Time Price Chart -->
            <div class="card">
                <h2>Price Movement Analysis</h2>
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
                <div class="chart-controls">
                    <button class="btn btn-primary" onclick="toggleChartType()">Toggle Chart Type</button>
                    <button class="btn btn-secondary" onclick="addTechnicalIndicator()">Add Moving Average</button>
                    <button class="btn btn-secondary" onclick="exportChart()">Export Chart</button>
                </div>
            </div>
            
            <div class="card">
                <h2>AI-Powered Predictions</h2>
                <div class="metric-grid">
                    <div class="metric-card" style="background: var(--gradient-primary);">
                        <h3>Predicted Change</h3>
                        <div class="value">{{ prediction_data.get('Predicted Change', 'N/A') }}</div>
                        <div class="subtitle">Next Period Forecast</div>
                    </div>
                    <div class="metric-card" style="background: {% if prediction_data.get('Trading Signal') == 'BUY' %}var(--gradient-success){% elif prediction_data.get('Trading Signal') == 'SELL' %}var(--gradient-warning){% else %}var(--gradient-info){% endif %};">
                        <h3>Trading Signal</h3>
                        <div class="value">{{ prediction_data.get('Trading Signal', 'N/A') }}</div>
                        <div class="subtitle">Algorithmic Recommendation</div>
                    </div>
                    <div class="metric-card" style="background: var(--gradient-info);">
                        <h3>Model Confidence</h3>
                        <div class="value">{{ prediction_data.get('Confidence', 'N/A') }}%</div>
                        <div class="subtitle">Prediction Accuracy</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 12px;">
                    <h4 style="margin: 0 0 15px 0; color: var(--primary-color);">Model Performance Metrics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; font-size: 0.9em;">
                        <div style="text-align: center;">
                            <div style="font-weight: 600; color: var(--success-color); font-size: 1.2em;">73.2%</div>
                            <div style="color: #666;">Accuracy</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: 600; color: var(--info-color); font-size: 1.2em;">68.9%</div>
                            <div style="color: #666;">Precision</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: 600; color: var(--warning-color); font-size: 1.2em;">71.4%</div>
                            <div style="color: #666;">Recall</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: 600; color: var(--primary-color); font-size: 1.2em;">70.1%</div>
                            <div style="color: #666;">F1-Score</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="market-data-tab" class="tab-content">
            <div class="card">
                <h2>Real-Time Market Data</h2>
                <div style="display: flex; align-items: center; margin-bottom: 20px;">
                    <span class="status-indicator status-live"></span>
                    <span style="font-weight: 500; color: var(--primary-color);">Live data feed active</span>
                </div>
                
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">Related Asset Performance</h3>
                <div class="metric-grid">
                    {% for asset, data in related_assets.items() %}
                    <div style="padding: 20px; background: white; border-radius: 12px; border: 1px solid #e2e8f0; transition: all 0.3s ease;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: var(--primary-color); font-size: 1.1em;">{{ asset }}</h4>
                            <span class="{% if data.get('change', 0)|float > 0 %}positive{% else %}negative{% endif %}" style="font-weight: 600;">
                                {{ data.get('change', 0)|float|round(2) }}%
                            </span>
                        </div>
                        <div style="font-size: 1.4em; font-weight: 600; color: var(--secondary-color);">
                            ${{ data.get('price', 'N/A') }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="analytics-tab" class="tab-content">
            <div class="card">
                <h2>Portfolio Performance Overview</h2>
                <div class="metric-grid">
                    <!-- Key Metrics -->
                    <div class="metric-card" style="background: var(--gradient-primary);">
                        <h3>Total Return</h3>
                        <div class="value">{{ (best_strategy.get('Strategy_Return', 0)|float * 100)|round(2) }}%</div>
                        <div class="subtitle">vs Market: +{{ ((best_strategy.get('Strategy_Return', 0)|float - 0.15) * 100)|round(2) }}%</div>
                    </div>
                    
                    <div class="metric-card" style="background: var(--gradient-warning);">
                        <h3>Sharpe Ratio</h3>
                        <div class="value">{{ best_strategy.get('Strategy_Sharpe', 0)|float|round(2) }}</div>
                        <div class="subtitle">Risk-Adjusted Return</div>
                    </div>
                    
                    <div class="metric-card" style="background: var(--gradient-success);">
                        <h3>Win Rate</h3>
                        <div class="value">{{ (best_strategy.get('Win_Rate', 0)|float * 100)|round(1) }}%</div>
                        <div class="subtitle">Successful Trades</div>
                    </div>
                    
                    <div class="metric-card" style="background: var(--gradient-info);">
                        <h3>Max Drawdown</h3>
                        <div class="value">-8.3%</div>
                        <div class="subtitle">Worst Loss Period</div>
                    </div>
                </div>
            </div>
            
            <!-- Risk Analytics -->
            <div class="card">
                <h2>Risk Management Analytics</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">Value at Risk (VaR)</h3>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #666;">1-Day VaR (95%):</span>
                                <strong style="color: var(--accent-color);">-$2,340</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #666;">1-Week VaR (95%):</span>
                                <strong style="color: var(--accent-color);">-$8,920</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">1-Month VaR (95%):</span>
                                <strong style="color: var(--accent-color);">-$18,450</strong>
                            </div>
                        </div>
                        
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">Volatility Metrics</h3>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #666;">Daily Volatility:</span>
                                <strong style="color: var(--info-color);">2.34%</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #666;">Annualized Vol:</span>
                                <strong style="color: var(--info-color);">37.2%</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">Beta (vs Market):</span>
                                <strong style="color: var(--info-color);">1.23</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">Performance Attribution</h3>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #666;">Alpha Generation:</span>
                                <strong style="color: var(--success-color);">+4.2%</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #666;">Market Beta:</span>
                                <strong style="color: var(--info-color);">+8.9%</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">Residual Return:</span>
                                <strong style="color: var(--warning-color);">+1.1%</strong>
                            </div>
                        </div>
                        
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">Trade Analytics</h3>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #666;">Total Trades:</span>
                                <strong style="color: var(--primary-color);">247</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #666;">Avg Trade Duration:</span>
                                <strong style="color: var(--primary-color);">3.2 days</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">Profit Factor:</span>
                                <strong style="color: var(--success-color);">1.68</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Model Comparison -->
            <div class="card">
                <h2>Machine Learning Model Comparison</h2>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th style="text-align: center;">Accuracy</th>
                                <th style="text-align: center;">Precision</th>
                                <th style="text-align: center;">Recall</th>
                                <th style="text-align: center;">F1-Score</th>
                                <th style="text-align: center;">Sharpe</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>LSTM Ensemble</strong> <span style="color: var(--warning-color); font-size: 0.8em;">CHAMPION</span></td>
                                <td style="text-align: center; color: var(--success-color);"><strong>73.2%</strong></td>
                                <td style="text-align: center;">68.9%</td>
                                <td style="text-align: center;">71.4%</td>
                                <td style="text-align: center;">70.1%</td>
                                <td style="text-align: center; color: var(--success-color);"><strong>2.34</strong></td>
                            </tr>
                            <tr>
                                <td>Random Forest</td>
                                <td style="text-align: center;">69.8%</td>
                                <td style="text-align: center;">65.2%</td>
                                <td style="text-align: center;">68.7%</td>
                                <td style="text-align: center;">66.9%</td>
                                <td style="text-align: center;">1.89</td>
                            </tr>
                            <tr>
                                <td>XGBoost</td>
                                <td style="text-align: center;">67.4%</td>
                                <td style="text-align: center;">63.8%</td>
                                <td style="text-align: center;">66.1%</td>
                                <td style="text-align: center;">64.9%</td>
                                <td style="text-align: center;">1.76</td>
                            </tr>
                            <tr>
                                <td>Linear Regression</td>
                                <td style="text-align: center;">61.2%</td>
                                <td style="text-align: center;">58.9%</td>
                                <td style="text-align: center;">59.8%</td>
                                <td style="text-align: center;">59.3%</td>
                                <td style="text-align: center;">1.42</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="news-tab" class="tab-content">
            <div class="card">
                <h2>Market Intelligence</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h3 style="color: var(--primary-color);">Market Sentiment Analysis</h3>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                <span style="color: #666;">Overall Sentiment:</span>
                                <strong style="color: var(--success-color);">{{ news_sentiment.get('overall_sentiment', 'N/A') }}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">Sentiment Score:</span>
                                <strong style="color: var(--info-color);">{{ news_sentiment.get('sentiment_score', 'N/A') }}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: var(--primary-color);">News Distribution</h3>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">Positive:</span>
                                <span style="color: var(--success-color); font-weight: 600;">{{ news_sentiment.get('news_count', {}).get('positive', 0) }}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">Neutral:</span>
                                <span style="color: var(--warning-color); font-weight: 600;">{{ news_sentiment.get('news_count', {}).get('neutral', 0) }}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">Negative:</span>
                                <span style="color: var(--accent-color); font-weight: 600;">{{ news_sentiment.get('news_count', {}).get('negative', 0) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">Latest Market News</h3>
                {% for news in top_news[:3] %}
                <div style="margin-bottom: 20px; padding: 20px; border-left: 4px solid var(--primary-color); background: #f8fafc; border-radius: 0 12px 12px 0;">
                    <h4 style="margin: 0 0 10px 0; color: var(--primary-color);">{{ news.title }}</h4>
                    <p style="margin: 0 0 10px 0; color: #666; line-height: 1.5;">{{ news.summary }}</p>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #888;">
                        <span>{{ news.source }}</span>
                        <span>{{ news.published_at }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="analysis-tab" class="tab-content">
            <div class="card">
                <h2>Trading Signal Analysis</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div class="metric-card" style="background: {% if prediction_data.get('Trading Signal') == 'BUY' %}var(--gradient-success){% elif prediction_data.get('Trading Signal') == 'SELL' %}var(--gradient-warning){% else %}var(--gradient-info){% endif %};">
                        <h3>Current Signal</h3>
                        <div class="value">{{ prediction_data.get('Trading Signal', 'HOLD') }}</div>
                        <div class="subtitle">Algorithmic Recommendation</div>
                    </div>
                    
                    <div class="metric-card" style="background: var(--gradient-primary);">
                        <h3>Signal Strength</h3>
                        <div class="value">{{ prediction_data.get('Confidence', 'N/A') }}%</div>
                        <div class="subtitle">Confidence Level</div>
                    </div>
                </div>
                
                <div style="background: #f8fafc; padding: 25px; border-radius: 12px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 20px;">Key Influencing Factors</h3>
                    <div style="font-size: 1.1em; color: #666; line-height: 1.6;">
                        {{ prediction_data.get('Top Factors', 'Trade_Weighted_Dollar, Industrial_Production, US_China_Exchange_Rate') }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Monte Carlo Simulation Tab -->
        <div id="monte-carlo-tab" class="tab-content">
            <div class="card">
                <h2>Monte Carlo Price Simulation</h2>
                <p style="color: #666; margin-bottom: 25px;">
                    Advanced probabilistic modeling to forecast copper price movements using thousands of simulated scenarios.
                </p>
                
                <!-- Simulation Controls -->
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; color: var(--primary-color);">Simulation Parameters</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Current Price ($)</label>
                            <input type="number" id="mc-current-price" value="5.84" step="0.01" 
                                   style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Time Horizon (Days)</label>
                            <select id="mc-days" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                                <option value="30">30 Days</option>
                                <option value="90" selected>90 Days</option>
                                <option value="180">180 Days</option>
                                <option value="252">1 Year</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Simulations</label>
                            <select id="mc-simulations" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                                <option value="500">500 (Fast)</option>
                                <option value="1000" selected>1,000 (Standard)</option>
                                <option value="5000">5,000 (Detailed)</option>
                                <option value="10000">10,000 (Comprehensive)</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button onclick="runMonteCarloSimulation()" class="btn btn-primary" style="width: 100%;">
                                Run Simulation
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Loading Indicator -->
                <div id="mc-loading" style="display: none; text-align: center; padding: 40px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 15px; color: #666;">Running Monte Carlo simulation...</p>
                </div>
                
                <!-- Results Display -->
                <div id="mc-results" style="display: none;">
                    <!-- Key Metrics -->
                    <div class="metric-grid" style="margin-bottom: 25px;">
                        <div class="metric-card" style="background: var(--gradient-primary);">
                            <h3>Expected Price</h3>
                            <div class="value" id="mc-expected-price">$0.00</div>
                            <div class="subtitle">Mean Forecast</div>
                        </div>
                        <div class="metric-card" style="background: var(--gradient-success);">
                            <h3>Profit Probability</h3>
                            <div class="value" id="mc-profit-prob">0%</div>
                            <div class="subtitle">Chance of Gain</div>
                        </div>
                        <div class="metric-card" style="background: var(--gradient-warning);">
                            <h3>Value at Risk</h3>
                            <div class="value" id="mc-var">0%</div>
                            <div class="subtitle">95% Confidence</div>
                        </div>
                        <div class="metric-card" style="background: var(--gradient-info);">
                            <h3>Risk Level</h3>
                            <div class="value" id="mc-risk-level">-</div>
                            <div class="subtitle">Assessment</div>
                        </div>
                    </div>
                    
                    <!-- Recommendation -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                        <h3 style="margin: 0 0 15px 0; color: var(--primary-color);">Trading Recommendation</h3>
                        <div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                            <p id="mc-recommendation" style="margin: 0; color: #666; font-size: 1.1em;">Run simulation to get recommendation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Correlation Analysis Tab -->
        <div id="correlation-tab" class="tab-content">
            <div class="card">
                <h2>Asset Correlation Analysis</h2>
                <p style="color: #666; margin-bottom: 25px;">
                    Analyze relationships between copper and other financial assets to identify diversification opportunities and systemic risks.
                </p>
                
                <!-- Analysis Controls -->
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; color: var(--primary-color);">Analysis Parameters</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Analysis Type</label>
                            <select id="corr-analysis-type" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                                <option value="copper_focused" selected>Copper-Focused</option>
                                <option value="general">General Market</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Time Period</label>
                            <select id="corr-period" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                                <option value="3m">3 Months</option>
                                <option value="6m" selected>6 Months</option>
                                <option value="1y">1 Year</option>
                                <option value="2y">2 Years</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button onclick="runCorrelationAnalysis()" class="btn btn-primary" style="width: 100%;">
                                Analyze Correlations
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Loading Indicator -->
                <div id="corr-loading" style="display: none; text-align: center; padding: 40px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 15px; color: #666;">Analyzing correlations...</p>
                </div>
                
                <!-- Results Display -->
                <div id="corr-results" style="display: none;">
                    <!-- Key Insights -->
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 15px 0; color: var(--primary-color);">Key Insights</h3>
                        <div id="corr-insights">
                            <p style="color: #666;">Run analysis to see insights</p>
                        </div>
                    </div>
                    
                    <!-- Correlation Matrix -->
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 15px 0; color: var(--primary-color);">Copper Correlations</h3>
                        <div id="corr-matrix" style="overflow-x: auto;">
                            <!-- Correlation data will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Strongest Relationships -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                        <h3 style="margin: 0 0 15px 0; color: var(--primary-color);">Strongest Relationships</h3>
                        <div id="corr-strongest">
                            <!-- Top correlations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add CSS for loading spinner
        const spinnerCSS = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        `;
        const style = document.createElement('style');
        style.textContent = spinnerCSS;
        document.head.appendChild(style);
        // Simple, clean tab functionality
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            console.log(`Found ${tabs.length} tabs and ${tabContents.length} content sections`);
            
            // Remove existing event listeners by cloning
            tabs.forEach((tab, index) => {
                const newTab = tab.cloneNode(true);
                tab.parentNode.replaceChild(newTab, tab);
            });
            
            // Get fresh tabs after cloning
            const freshTabs = document.querySelectorAll('.tab');
            
            // Add click handlers
            freshTabs.forEach((tab, index) => {
                tab.addEventListener('click', function(e) {
                    console.log(`Tab clicked: ${this.textContent} -> ${this.getAttribute('data-target')}`);
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const targetId = this.getAttribute('data-target');
                    if (!targetId) {
                        console.error('No data-target found');
                        return;
                    }
                    
                    // Remove active from all tabs
                    freshTabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active to clicked tab
                    this.classList.add('active');
                    
                    // Hide all content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        content.style.display = 'none';
                    });
                    
                    // Show target content
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        targetContent.style.display = 'block';
                        console.log(` Activated: ${targetId}`);
                    } else {
                        console.error(` Content not found: ${targetId}`);
                    }
                });
                
                console.log(` Added listener to tab ${index}: ${tab.textContent}`);
            });
            
            // Ensure first tab is active
            if (freshTabs.length > 0) {
                const firstTab = freshTabs[0];
                const firstTarget = firstTab.getAttribute('data-target');
                const firstContent = document.getElementById(firstTarget);
                
                freshTabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => {
                    c.classList.remove('active');
                    c.style.display = 'none';
                });
                
                firstTab.classList.add('active');
                if (firstContent) {
                    firstContent.classList.add('active');
                    firstContent.style.display = 'block';
                    console.log(` Set default tab: ${firstTarget}`);
                }
            }
            
            console.log(" Tab initialization complete!");
        }
        
        // Chart functionality
        let priceChart = null;
        let chartType = 'line';
        let priceData = [];
        
        function initPriceChart() {
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;
            
            // Generate sample data for demo
            const now = new Date();
            priceData = [];
            for (let i = 30; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                const basePrice = 5.84;
                const price = basePrice + (Math.random() - 0.5) * 0.5;
                priceData.push({
                    x: date,
                    y: price
                });
            }
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'COMEX Copper Price',
                        data: priceData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Real-Time Copper Price Movement',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price ($)'
                            },
                            beginAtZero: false
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        function toggleChartType() {
            if (!priceChart) return;
            
            chartType = chartType === 'line' ? 'bar' : 'line';
            
            if (chartType === 'line') {
                priceChart.config.type = 'line';
                priceChart.data.datasets[0] = {
                    label: 'COMEX Copper Price',
                    data: priceData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 6
                };
            } else {
                priceChart.config.type = 'bar';
                priceChart.data.datasets[0] = {
                    label: 'COMEX Copper Price',
                    data: priceData,
                    backgroundColor: priceData.map(d => d.y > 5.84 ? 'rgba(56, 161, 105, 0.8)' : 'rgba(229, 62, 62, 0.8)'),
                    borderColor: priceData.map(d => d.y > 5.84 ? 'rgb(56, 161, 105)' : 'rgb(229, 62, 62)'),
                    borderWidth: 1
                };
            }
            
            priceChart.update();
        }
        
        function addTechnicalIndicator() {
            if (!priceChart) return;
            
            // Calculate simple moving average
            const smaData = [];
            const period = 5;
            
            for (let i = period - 1; i < priceData.length; i++) {
                const sum = priceData.slice(i - period + 1, i + 1).reduce((acc, d) => acc + d.y, 0);
                smaData.push({
                    x: priceData[i].x,
                    y: sum / period
                });
            }
            
            // Check if SMA already exists
            const existingSMA = priceChart.data.datasets.find(dataset => dataset.label === 'SMA (5)');
            if (existingSMA) {
                // Remove existing SMA
                priceChart.data.datasets = priceChart.data.datasets.filter(dataset => dataset.label !== 'SMA (5)');
            } else {
                // Add SMA line to chart
                priceChart.data.datasets.push({
                    label: 'SMA (5)',
                    data: smaData,
                    borderColor: '#f6ad55',
                    backgroundColor: 'rgba(246, 173, 85, 0.1)',
                    tension: 0.4,
                    fill: false,
                    type: 'line',
                    pointRadius: 2,
                    pointHoverRadius: 4
                });
            }
            
            priceChart.update();
        }
        
        function exportChart() {
            if (!priceChart) return;
            
            const url = priceChart.toBase64Image();
            const link = document.createElement('a');
            link.download = 'copperflow-price-chart.png';
            link.href = url;
            link.click();
        }
        
        // Update chart with real-time data
        function updateChart(newPrice) {
            if (!priceChart || !newPrice) return;
            
            const now = new Date();
            const newDataPoint = {
                x: now,
                y: newPrice.price
            };
            
            priceData.push(newDataPoint);
            
            // Keep only last 30 data points
            if (priceData.length > 30) {
                priceData.shift();
            }
            
            priceChart.data.datasets[0].data = priceData;
            priceChart.update('none'); // No animation for real-time updates
        }
        
        function initSocketConnection() {
            console.log('Initializing WebSocket connection...');
            
            // Initialize Socket.IO connection
            socket = io();
            
            // Connection event handlers
            socket.on('connect', function() {
                connectionStatus = 'connected';
                reconnectAttempts = 0;
                updateConnectionStatus('connected');
                console.log(' WebSocket connected');
                
                // Subscribe to price alerts
                socket.emit('subscribe_alerts', {
                    threshold: 1.0,
                    type: 'price_change'
                });
            });
            
            socket.on('disconnect', function() {
                connectionStatus = 'disconnected';
                updateConnectionStatus('disconnected');
                console.log(' WebSocket disconnected');
                
                // Attempt to reconnect
                attemptReconnection();
            });
            
            socket.on('connect_error', function(error) {
                console.error('WebSocket connection error:', error);
                updateConnectionStatus('error');
                attemptReconnection();
            });
            
            // Data event handlers
            socket.on('price_update', function(data) {
                console.log(' Received price update:', data);
                updateRealTimeData(data);
                updateChart(data);
                showDataUpdateNotification(data);
            });
            
            socket.on('trading_alert', function(alert) {
                console.log(' Trading alert received:', alert);
                showTradingAlert(alert);
            });
            
            socket.on('connection_status', function(status) {
                console.log('Connection status:', status);
                updateConnectionStatus(status.status);
            });
            
            socket.on('error', function(error) {
                console.error('WebSocket error:', error);
                showErrorNotification(error.message);
            });
        }
        
        function attemptReconnection() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                
                console.log(`Attempting reconnection ${reconnectAttempts}/${maxReconnectAttempts} in ${delay}ms`);
                updateConnectionStatus('reconnecting');
                
                setTimeout(() => {
                    if (socket) {
                        socket.connect();
                    }
                }, delay);
            } else {
                console.error('Max reconnection attempts reached');
                updateConnectionStatus('failed');
            }
        }
        
        function updateConnectionStatus(status) {
            const statusElement = document.querySelector('.status-indicator');
            const statusText = document.querySelector('.connection-status-text');
            
            if (statusElement) {
                statusElement.className = 'status-indicator';
                
                switch(status) {
                    case 'connected':
                        statusElement.classList.add('status-live');
                        if (statusText) statusText.textContent = 'Live data feed active';
                        break;
                    case 'disconnected':
                        statusElement.classList.add('status-disconnected');
                        if (statusText) statusText.textContent = 'Connection lost';
                        break;
                    case 'reconnecting':
                        statusElement.classList.add('status-reconnecting');
                        if (statusText) statusText.textContent = 'Reconnecting...';
                        break;
                    case 'error':
                    case 'failed':
                        statusElement.classList.add('status-error');
                        if (statusText) statusText.textContent = 'Connection failed';
                        break;
                }
            }
        }
        
        function updateRealTimeData(data) {
            // Update price display
            const priceElement = document.querySelector('.price-display');
            if (priceElement && data.price) {
                priceElement.textContent = `$${data.price}`;
                
                // Add flash effect
                priceElement.classList.add('price-flash');
                setTimeout(() => priceElement.classList.remove('price-flash'), 1000);
            }
            
            // Update change display
            const changeElement = document.querySelector('.price-change');
            if (changeElement && data.change_percent !== undefined) {
                const changePercent = data.change_percent;
                const changeAmount = data.change || 0;
                
                changeElement.className = 'price-change';
                if (changePercent > 0) {
                    changeElement.classList.add('positive');
                } else if (changePercent < 0) {
                    changeElement.classList.add('negative');
                }
                
                changeElement.innerHTML = `
                    <span class="change-amount">${changeAmount >= 0 ? '+' : ''}$${changeAmount.toFixed(2)}</span>
                    <span class="change-percent">(${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)</span>
                `;
            }
            
            // Update other metrics
            if (data.high) {
                const highElement = document.querySelector('[data-metric="high"]');
                if (highElement) highElement.textContent = `$${data.high}`;
            }
            
            if (data.low) {
                const lowElement = document.querySelector('[data-metric="low"]');
                if (lowElement) lowElement.textContent = `$${data.low}`;
            }
            
            if (data.volume) {
                const volumeElement = document.querySelector('[data-metric="volume"]');
                if (volumeElement) volumeElement.textContent = data.volume;
            }
            
            // Update timestamp
            if (data.timestamp) {
                const timestampElement = document.querySelector('[data-metric="timestamp"]');
                if (timestampElement) {
                    const date = new Date(data.timestamp);
                    timestampElement.textContent = date.toLocaleTimeString();
                }
            }
        }
        
        function showDataUpdateNotification(data) {
            // Create subtle notification for data updates
            const notification = document.createElement('div');
            notification.className = 'data-update-notification';
            notification.innerHTML = `
                <span class="notification-icon"></span>
                <span>Price updated: $${data.price}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        function showTradingAlert(alert) {
            // Create prominent alert notification
            const alertDiv = document.createElement('div');
            alertDiv.className = 'trading-alert';
            alertDiv.innerHTML = `
                <div class="alert-header">
                    <span class="alert-icon"></span>
                    <span class="alert-title">Trading Alert</span>
                    <button class="alert-close" onclick="this.parentNode.parentNode.remove()"></button>
                </div>
                <div class="alert-message">${alert.message}</div>
                <div class="alert-details">
                    Price: $${alert.price} | Change: ${alert.change_percent:+.2f}%
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 10000);
            
            // Browser notification if supported
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('CopperFlow Trading Alert', {
                    body: alert.message,
                    icon: '/static/favicon.ico'
                });
            }
        }
        
        function showErrorNotification(message) {
            console.error('Error notification:', message);
            // Could add user-visible error notifications here
        }
        
        function requestManualUpdate() {
            if (socket && socket.connected) {
                socket.emit('request_update');
                console.log('Manual update requested');
            } else {
                console.warn('Cannot request update: WebSocket not connected');
            }
        }
        
        // Request notification permission on page load
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log('Notification permission:', permission);
                });
            }
        }
        
        // Monte Carlo Simulation Functions
        async function runMonteCarloSimulation() {
            const currentPrice = parseFloat(document.getElementById('mc-current-price').value);
            const days = parseInt(document.getElementById('mc-days').value);
            const nSimulations = parseInt(document.getElementById('mc-simulations').value);
            
            // Show loading
            document.getElementById('mc-loading').style.display = 'block';
            document.getElementById('mc-results').style.display = 'none';
            
            try {
                const response = await fetch('/api/monte_carlo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_price: currentPrice,
                        days: days,
                        n_simulations: nSimulations
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayMonteCarloResults(data.results, data.summary);
                } else {
                    alert('Error running simulation: ' + data.error);
                }
                
            } catch (error) {
                console.error('Error running Monte Carlo simulation:', error);
                alert('Error running simulation. Please try again.');
            } finally {
                document.getElementById('mc-loading').style.display = 'none';
            }
        }
        
        function displayMonteCarloResults(results, summary) {
            const stats = results.statistics;
            
            // Update key metrics
            document.getElementById('mc-expected-price').textContent = `$${stats.mean_final_price.toFixed(2)}`;
            document.getElementById('mc-profit-prob').textContent = `${(stats.probability_profit * 100).toFixed(1)}%`;
            document.getElementById('mc-var').textContent = `${(stats.var_95 * 100).toFixed(1)}%`;
            document.getElementById('mc-risk-level').textContent = summary.risk_assessment;
            
            // Update recommendation
            document.getElementById('mc-recommendation').textContent = summary.recommendation;
            
            // Show results
            document.getElementById('mc-results').style.display = 'block';
            
            console.log('Monte Carlo results displayed successfully');
        }
        
        // Correlation Analysis Functions
        async function runCorrelationAnalysis() {
            const analysisType = document.getElementById('corr-analysis-type').value;
            const period = document.getElementById('corr-period').value;
            
            // Show loading
            document.getElementById('corr-loading').style.display = 'block';
            document.getElementById('corr-results').style.display = 'none';
            
            try {
                const response = await fetch('/api/correlation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        analysis_type: analysisType,
                        period: period
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayCorrelationResults(data.results);
                } else {
                    alert('Error running correlation analysis: ' + data.error);
                }
                
            } catch (error) {
                console.error('Error running correlation analysis:', error);
                alert('Error running analysis. Please try again.');
            } finally {
                document.getElementById('corr-loading').style.display = 'none';
            }
        }
        
        function displayCorrelationResults(results) {
            // Display insights
            const insights = results.insights || [];
            const insightsHtml = insights.map(insight => 
                `<div style="padding: 10px; margin-bottom: 10px; background: #f0f8ff; border-left: 4px solid var(--info-color); border-radius: 4px;">
                    ${insight}
                </div>`
            ).join('');
            document.getElementById('corr-insights').innerHTML = insightsHtml || '<p style="color: #666;">No specific insights available.</p>';
            
            // Display correlation matrix
            const correlationData = results.correlation_data;
            if (correlationData && correlationData.statistics.copper_correlations) {
                const copperCorrs = correlationData.statistics.copper_correlations;
                const matrixHtml = Object.entries(copperCorrs)
                    .map(([symbol, corr]) => 
                        `<div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                            <span style="font-weight: 500;">${symbol}</span>
                            <span style="color: ${corr > 0 ? 'var(--success-color)' : 'var(--accent-color)'}; font-weight: 600;">
                                ${corr.toFixed(3)}
                            </span>
                        </div>`
                    ).join('');
                document.getElementById('corr-matrix').innerHTML = matrixHtml;
            }
            
            // Display strongest correlations
            if (correlationData && correlationData.statistics.strongest_correlations) {
                const strongestHtml = correlationData.statistics.strongest_correlations
                    .slice(0, 5)
                    .map(item => 
                        `<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px;">
                            <span style="font-weight: 500;">${item.symbol1}  ${item.symbol2}</span>
                            <span style="color: ${item.correlation > 0 ? 'var(--success-color)' : 'var(--accent-color)'}; font-weight: 600; font-size: 1.1em;">
                                ${item.correlation.toFixed(3)}
                            </span>
                        </div>`
                    ).join('');
                document.getElementById('corr-strongest').innerHTML = strongestHtml;
            }
            
            // Show results
            document.getElementById('corr-results').style.display = 'block';
            
            console.log('Correlation results displayed successfully');
        }
        
        // Load quick analysis on page load
        async function loadQuickAnalysis() {
            try {
                // Load quick Monte Carlo simulation
                const mcResponse = await fetch('/api/quick_simulation');
                if (mcResponse.ok) {
                    const mcData = await mcResponse.json();
                    if (mcData.success) {
                        console.log('Quick Monte Carlo loaded:', mcData);
                        // Could display summary in dashboard tab
                    }
                }
                
                // Load quick correlation analysis
                const corrResponse = await fetch('/api/quick_correlation');
                if (corrResponse.ok) {
                    const corrData = await corrResponse.json();
                    if (corrData.success) {
                        console.log('Quick correlation loaded:', corrData);
                        // Could display summary in dashboard tab
                    }
                }
            } catch (error) {
                console.log('Quick analysis not available:', error);
            }
        }
        
        function initPriceChart() {
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;
            
            // Generate sample data for demo
            const now = new Date();
            priceData = [];
            for (let i = 30; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                const basePrice = 5.84;
                const price = basePrice + (Math.random() - 0.5) * 0.5;
                priceData.push({
                    x: date,
                    y: price
                });
            }
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'COMEX Copper Price',
                        data: priceData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Real-Time Copper Price Movement',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price ($)'
                            },
                            beginAtZero: false
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        function toggleChartType() {
            if (!priceChart) return;
            
            chartType = chartType === 'line' ? 'bar' : 'line';
            
            if (chartType === 'line') {
                priceChart.config.type = 'line';
                priceChart.data.datasets[0] = {
                    label: 'COMEX Copper Price',
                    data: priceData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 6
                };
            } else {
                priceChart.config.type = 'bar';
                priceChart.data.datasets[0] = {
                    label: 'COMEX Copper Price',
                    data: priceData,
                    backgroundColor: priceData.map(d => d.y > 5.84 ? 'rgba(56, 161, 105, 0.8)' : 'rgba(229, 62, 62, 0.8)'),
                    borderColor: priceData.map(d => d.y > 5.84 ? 'rgb(56, 161, 105)' : 'rgb(229, 62, 62)'),
                    borderWidth: 1
                };
            }
            
            priceChart.update();
        }
        
        function addTechnicalIndicator() {
            if (!priceChart) return;
            
            // Calculate simple moving average
            const smaData = [];
            const period = 5;
            
            for (let i = period - 1; i < priceData.length; i++) {
                const sum = priceData.slice(i - period + 1, i + 1).reduce((acc, d) => acc + d.y, 0);
                smaData.push({
                    x: priceData[i].x,
                    y: sum / period
                });
            }
            
            // Check if SMA already exists
            const existingSMA = priceChart.data.datasets.find(dataset => dataset.label === 'SMA (5)');
            if (existingSMA) {
                // Remove existing SMA
                priceChart.data.datasets = priceChart.data.datasets.filter(dataset => dataset.label !== 'SMA (5)');
            } else {
                // Add SMA line to chart
                priceChart.data.datasets.push({
                    label: 'SMA (5)',
                    data: smaData,
                    borderColor: '#f6ad55',
                    backgroundColor: 'rgba(246, 173, 85, 0.1)',
                    tension: 0.4,
                    fill: false,
                    type: 'line',
                    pointRadius: 2,
                    pointHoverRadius: 4
                });
            }
            
            priceChart.update();
        }
        
        function exportChart() {
            if (!priceChart) return;
            
            const url = priceChart.toBase64Image();
            const link = document.createElement('a');
            link.download = 'copperflow-price-chart.png';
            link.href = url;
            link.click();
        }
        
        // Make functions globally available
        window.toggleChartType = toggleChartType;
        window.addTechnicalIndicator = addTechnicalIndicator;
        window.exportChart = exportChart;
        window.updateChart = updateChart;
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initTabs();
                initPriceChart();
                initSocketConnection();
                requestNotificationPermission();
                loadQuickAnalysis();
            }, 100);
        });
    </script>
</body>
</html>
