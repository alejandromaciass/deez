<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CopperQuant Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        .card h2 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-actions {
            display: flex;
            gap: 10px;
        }
        .card-action {
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 16px;
        }
        .card-action:hover {
            color: #2c3e50;
        }
        .prediction {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .prediction-value {
            font-size: 24px;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .prediction-value.highlight {
            color: #e74c3c;
        }
        .signal {
            padding: 10px 20px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            transition: transform 0.3s ease;
        }
        .signal.buy {
            background-color: #27ae60;
        }
        .signal.sell {
            background-color: #e74c3c;
        }
        .signal.hold {
            background-color: #f39c12;
        }
        .signal.pulse {
            transform: scale(1.05);
        }
        .chart-container {
            margin-top: 20px;
            position: relative;
            height: 300px;
        }
        .chart-container img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            transition: transform 0.3s ease;
        }
        .chart-container img:hover {
            transform: scale(1.02);
        }
        .chart-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(44, 62, 80, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        table th {
            background-color: #f2f2f2;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        .metric:hover {
            background-color: #eaeaea;
        }
        .metric-name {
            font-weight: bold;
        }
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        .report {
            white-space: pre-wrap;
            font-family: monospace;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .tab:hover {
            background-color: #f5f5f5;
        }
        .tab.active {
            border-bottom: 2px solid #2c3e50;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .refresh-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .refresh-btn:hover {
            background-color: #2980b9;
        }
        .timestamp {
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-size: 12px;
            opacity: 0.8;
        }
        .tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
        }
        .chart-toggle {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-actions {
            margin-top: 20px;
        }
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .strategy-result-card {
            border-left: 4px solid #27ae60;
            margin-top: 20px;
        }
        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px;
            border-radius: 4px;
            background-color: #2ecc71;
            color: white;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        .status.error {
            background-color: #e74c3c;
        }
        .status.hidden {
            opacity: 0;
        }
        .model-info {
            padding: 10px 0;
        }
        .model-description {
            margin-top: 15px;
            line-height: 1.5;
            color: #555;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        .strategy-explanation {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .strategy-type-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .strategy-type {
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .strategy-type h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #7f8c8d;
            font-size: 12px;
        }
        .error-message {
            padding: 10px;
            margin: 15px 0;
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 4px;
            border-left: 3px solid #e74c3c;
        }
        .btn-secondary {
            background-color: #95a5a6;
            margin-left: 10px;
        }
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        .note {
            font-style: italic;
            color: #7f8c8d;
            margin-top: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <header>
        <h1>CopperQuant Trading Signal Generator</h1>
        <p>Advanced copper price prediction and trading signals</p>
        <button id="refresh-btn" class="refresh-btn">Refresh Data</button>
        <div id="timestamp" class="timestamp">Last updated: {{ prediction_data.get('Date', 'N/A') }}</div>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-target="dashboard-tab">Dashboard</div>
            <div class="tab" data-target="analysis-tab">Analysis</div>
            <div class="tab" data-target="strategy-tab">Strategy Builder</div>
            <div class="tab" data-target="report-tab">Full Report</div>
        </div>

        <div id="dashboard-tab" class="tab-content active">
            <div class="dashboard-grid">
                <!-- Prediction Card -->
                <div class="card">
                    <h2>
                        Current Prediction
                        <div class="card-actions">
                            <button class="card-action" data-tooltip="This shows the current prediction for copper price movement">ⓘ</button>
                        </div>
                    </h2>
                    <div class="prediction">
                        <div>
                            <p>Current Price: <span class="prediction-value">{{ prediction_data.get('Current Price', 'N/A') }}</span></p>
                            <p>Predicted Change: <span class="prediction-value">{{ prediction_data.get('Predicted Change', 'N/A') }}</span></p>
                            <p>Predicted Price: <span class="prediction-value">{{ prediction_data.get('Predicted Price', 'N/A') }}</span></p>
                        </div>
                        <div>
                            {% set signal = prediction_data.get('Trading Signal', '').strip() %}
                            <div class="signal {{ signal.lower() if signal else 'hold' }}">
                                {{ signal if signal else 'HOLD' }}
                            </div>
                        </div>
                    </div>
                    <p>Date: {{ prediction_data.get('Date', 'N/A') }}</p>
                    <p>Top Factors: {{ prediction_data.get('Top Factors', 'N/A') }}</p>
                </div>

                <!-- Price Chart Card -->
                <div class="card">
                    <h2>
                        Copper Price History
                        <div class="card-actions">
                            <button class="card-action" data-tooltip="Historical copper price data">ⓘ</button>
                        </div>
                    </h2>
                    <div class="chart-container">
                        <canvas id="price-chart"></canvas>
                    </div>
                </div>

                <!-- Strategy Performance Card -->
                <div class="card">
                    <h2>
                        Strategy Performance
                        <div class="card-actions">
                            <button class="card-action" data-tooltip="Performance comparison of trading strategies">ⓘ</button>
                        </div>
                    </h2>
                    <div class="chart-container" id="strategy-chart">
                        <img src="/results/strategy_comparison.png" alt="Strategy Performance Chart">
                    </div>
                    <h3>Best Strategy: {{ best_strategy.get('Strategy', 'N/A') }}</h3>
                    <div class="metric">
                        <span class="metric-name">Return:</span>
                        <span>{{ "%.2f"|format(best_strategy.get('Strategy_Return', 0) * 100) }}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">Sharpe Ratio:</span>
                        <span>{{ "%.2f"|format(best_strategy.get('Strategy_Sharpe', 0)) }}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">Win Rate:</span>
                        <span>{{ "%.2f"|format(best_strategy.get('Win_Rate', 0) * 100) }}%</span>
                    </div>
                </div>

                <!-- Model Insights Card -->
                <div class="card">
                    <h2>
                        Model Insights
                        <div class="card-actions">
                            <button class="card-action" data-tooltip="Key factors influencing the prediction">ⓘ</button>
                        </div>
                    </h2>
                    <div class="chart-container" id="features-chart">
                        <img src="/results/top_features_prediction.png" alt="Feature Importance">
                    </div>
                </div>
                
                <!-- Model Information Card -->
                <div class="card">
                    <h2>
                        Model Information
                        <div class="card-actions">
                            <button class="card-action" data-tooltip="Details about the machine learning models used">ⓘ</button>
                        </div>
                    </h2>
                    <div class="model-info">
                        <div class="metric">
                            <span class="metric-name">Primary Model:</span>
                            <span>Lasso Regression</span>
                        </div>
                        <div class="metric">
                            <span class="metric-name">Alternative Models:</span>
                            <span>Random Forest, Gradient Boosting</span>
                        </div>
                        <div class="metric">
                            <span class="metric-name">Training Data:</span>
                            <span>Monthly copper prices (2010-2025)</span>
                        </div>
                        <div class="metric">
                            <span class="metric-name">Features:</span>
                            <span>48 technical & macroeconomic indicators</span>
                        </div>
                        <div class="metric">
                            <span class="metric-name">Evaluation Metric:</span>
                            <span>RMSE: 0.0621, R²: 0.0071</span>
                        </div>
                        <p class="model-description">
                            <strong>Lasso Regression</strong> was selected as the primary model due to its ability to handle the high dimensionality of the feature space while maintaining interpretability. The model applies L1 regularization to select the most important features, reducing overfitting and improving generalization to new data.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div id="analysis-tab" class="tab-content">
            <!-- Trading Signals Card -->
            <div class="card">
                <h2>
                    Trading Signals
                    <div class="card-actions">
                        <button class="card-action" data-tooltip="Trading signals generated by the model">ⓘ</button>
                    </div>
                </h2>
                <div class="chart-container">
                    <img src="/results/trendfollowing_3_signals.png" alt="Trading Signals">
                </div>
            </div>

            <!-- Additional Analysis Cards in a grid -->
            <div class="dashboard-grid">
                <div class="card">
                    <h2>Strategy Returns</h2>
                    <div class="chart-container">
                        <img src="/results/trendfollowing_3_returns.png" alt="Strategy Returns">
                    </div>
                </div>
                <div class="card">
                    <h2>Strategy Drawdowns</h2>
                    <div class="chart-container">
                        <img src="/results/trendfollowing_3_drawdowns.png" alt="Strategy Drawdowns">
                    </div>
                </div>
            </div>
        </div>

        <div id="strategy-tab" class="tab-content">
            <!-- Custom Strategy Builder -->
            <div class="card">
                <h2>Custom Strategy Builder</h2>
                <p>Create and backtest your own trading strategy using the form below.</p>
                
                <div class="strategy-explanation">
                    <h3>Strategy Types</h3>
                    <div class="strategy-type-info">
                        <div class="strategy-type">
                            <h4>Threshold Strategy</h4>
                            <p>Generates buy signals when predicted returns exceed the buy threshold and sell signals when they fall below the sell threshold.</p>
                        </div>
                        <div class="strategy-type">
                            <h4>Moving Average Strategy</h4>
                            <p>Uses a moving average of predictions to generate signals, buying when the average is positive and selling when negative.</p>
                        </div>
                        <div class="strategy-type">
                            <h4>Trend Following Strategy</h4>
                            <p>Follows the trend of predictions, buying when the trend is rising and selling when falling, based on the specified window size.</p>
                        </div>
                    </div>
                </div>
                
                <form id="strategy-form">
                    <div class="form-group">
                        <label for="strategy_type">Strategy Type:</label>
                        <select id="strategy_type" name="strategy_type">
                            <option value="threshold">Threshold Strategy</option>
                            <option value="moving_average">Moving Average Strategy</option>
                            <option value="trend_following">Trend Following Strategy</option>
                        </select>
                    </div>
                    
                    <div class="form-group threshold-param">
                        <label for="buy_threshold">Buy Threshold (%):</label>
                        <input type="number" id="buy_threshold" name="buy_threshold" value="1.0" step="0.1" min="0">
                        <small>Minimum predicted return percentage to generate a buy signal</small>
                    </div>
                    
                    <div class="form-group threshold-param">
                        <label for="sell_threshold">Sell Threshold (%):</label>
                        <input type="number" id="sell_threshold" name="sell_threshold" value="-1.0" step="0.1" max="0">
                        <small>Maximum predicted return percentage to generate a sell signal</small>
                    </div>
                    
                    <div class="form-group window-param">
                        <label for="window_size">Window Size (periods):</label>
                        <input type="number" id="window_size" name="window_size" value="3" min="1" max="12">
                        <small>Number of periods to use for moving average or trend calculation</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn">Backtest Strategy</button>
                        <button type="button" id="reset-form" class="btn btn-secondary">Reset</button>
                    </div>
                </form>
                
                <div id="strategy-error" class="error-message" style="display: none;"></div>
                <div id="strategy-results"></div>
            </div>
        </div>

        <div id="report-tab" class="tab-content">
            <!-- Prediction Report Card -->
            <div class="card">
                <h2>Detailed Prediction Report</h2>
                <div class="report">{{ prediction_report }}</div>
            </div>
        </div>
    </div>

    <div id="status" class="status">System Online</div>

    <footer>
        <p>CopperQuant Trading Signal Generator &copy; 2025 | Last updated: {{ prediction_data.get('Date', 'N/A') }}</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tabs
            initTabs();
            
            // Initialize refresh button
            initRefreshButton();
            
            // Initialize tooltips
            initTooltips();
            
            // Initialize signal highlighting
            initSignalHighlighting();
            
            // Initialize custom strategy form
            initCustomStrategyForm();
            
            // Initialize price chart
            initPriceChart();
            
            // Initialize status checker
            initStatusChecker();
        });

        // Tab functionality
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            if (tabs.length > 0) {
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        // Remove active class from all tabs
                        tabs.forEach(t => t.classList.remove('active'));
                        // Add active class to clicked tab
                        this.classList.add('active');
                        
                        // Hide all tab content
                        const tabContents = document.querySelectorAll('.tab-content');
                        tabContents.forEach(content => content.classList.remove('active'));
                        
                        // Show the corresponding tab content
                        const targetId = this.getAttribute('data-target');
                        document.getElementById(targetId).classList.add('active');
                    });
                });
            }
        }

        // Refresh button functionality
        function initRefreshButton() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    // Show loading indicator
                    this.innerHTML = '<span class="spinner"></span> Refreshing...';
                    this.disabled = true;
                    
                    // Show status message
                    showStatus('Refreshing data...', 'normal');
                    
                    // Fetch new data
                    fetch('/api/status')
                        .then(response => response.json())
                        .then(data => {
                            // Simple page refresh for now
                            location.reload();
                        })
                        .catch(error => {
                            console.error('Error refreshing data:', error);
                            this.innerHTML = 'Refresh Failed';
                            showStatus('Refresh failed', 'error');
                            setTimeout(() => {
                                this.innerHTML = 'Refresh Data';
                                this.disabled = false;
                            }, 2000);
                        });
                });
            }
        }

        // Tooltip functionality
        function initTooltips() {
            const tooltips = document.querySelectorAll('[data-tooltip]');
            tooltips.forEach(tooltip => {
                tooltip.addEventListener('mouseover', function(e) {
                    const tooltipText = this.getAttribute('data-tooltip');
                    const tooltipElement = document.createElement('div');
                    tooltipElement.className = 'tooltip';
                    tooltipElement.textContent = tooltipText;
                    document.body.appendChild(tooltipElement);
                    
                    const rect = this.getBoundingClientRect();
                    tooltipElement.style.top = (rect.bottom + window.scrollY + 5) + 'px';
                    tooltipElement.style.left = (rect.left + window.scrollX) + 'px';
                });
                
                tooltip.addEventListener('mouseout', function() {
                    const tooltipElement = document.querySelector('.tooltip');
                    if (tooltipElement) {
                        tooltipElement.remove();
                    }
                });
            });
        }

        // Signal highlighting
        function initSignalHighlighting() {
            const signalElement = document.querySelector('.signal');
            if (signalElement) {
                // Add a pulsing effect to the signal
                setInterval(() => {
                    signalElement.classList.toggle('pulse');
                }, 1500);
            }
        }

        // Custom strategy form
        function initCustomStrategyForm() {
            const strategyForm = document.getElementById('strategy-form');
            const strategyType = document.getElementById('strategy_type');
            const resetButton = document.getElementById('reset-form');
            const errorElement = document.getElementById('strategy-error');
            
            // Show/hide parameters based on strategy type
            if (strategyType) {
                strategyType.addEventListener('change', function() {
                    updateStrategyParams(this.value);
                });
                
                // Initial update
                updateStrategyParams(strategyType.value);
            }
            
            // Reset form
            if (resetButton) {
                resetButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    strategyForm.reset();
                    document.getElementById('strategy-results').innerHTML = '';
                    errorElement.style.display = 'none';
                    updateStrategyParams(strategyType.value);
                });
            }
            
            if (strategyForm) {
                strategyForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Clear previous errors
                    errorElement.style.display = 'none';
                    
                    // Show loading indicator
                    const submitButton = this.querySelector('button[type="submit"]');
                    const originalText = submitButton.textContent;
                    submitButton.innerHTML = '<span class="spinner"></span> Processing...';
                    submitButton.disabled = true;
                    
                    // Get form data
                    const formData = new FormData(this);
                    const strategyData = {
                        strategy_type: formData.get('strategy_type'),
                        buy_threshold: parseFloat(formData.get('buy_threshold')),
                        sell_threshold: parseFloat(formData.get('sell_threshold')),
                        window_size: parseInt(formData.get('window_size'))
                    };
                    
                    // Validate data
                    if (isNaN(strategyData.buy_threshold) || isNaN(strategyData.sell_threshold) || isNaN(strategyData.window_size)) {
                        errorElement.textContent = 'Please enter valid numbers for all parameters';
                        errorElement.style.display = 'block';
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                        return;
                    }
                    
                    // Send to server
                    fetch('/api/custom-strategy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(strategyData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(result => {
                        // Check for error
                        if (result.error) {
                            throw new Error(result.error);
                        }
                        
                        // Display results
                        displayStrategyResults(result);
                        
                        // Reset button
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                        
                        // Show success message
                        showStatus('Strategy backtest completed', 'normal');
                    })
                    .catch(error => {
                        console.error('Error testing strategy:', error);
                        errorElement.textContent = `Error: ${error.message || 'Failed to process strategy'}`;
                        errorElement.style.display = 'block';
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                        showStatus('Strategy backtest failed', 'error');
                    });
                });
            }
            
            // Helper function to update visible parameters based on strategy type
            function updateStrategyParams(strategyType) {
                const thresholdParams = document.querySelectorAll('.threshold-param');
                const windowParams = document.querySelectorAll('.window-param');
                
                if (strategyType === 'threshold') {
                    thresholdParams.forEach(el => el.style.display = 'block');
                    windowParams.forEach(el => el.style.display = 'none');
                } else if (strategyType === 'moving_average' || strategyType === 'trend_following') {
                    thresholdParams.forEach(el => el.style.display = 'none');
                    windowParams.forEach(el => el.style.display = 'block');
                }
            }
        }

        // Display custom strategy results
        function displayStrategyResults(result) {
            const resultsContainer = document.getElementById('strategy-results');
            if (!resultsContainer) return;
            
            // Clear previous results
            resultsContainer.innerHTML = '';
            
            // Create results card
            const card = document.createElement('div');
            card.className = 'card strategy-result-card';
            
            // Add header
            const header = document.createElement('h3');
            header.textContent = 'Strategy Results: ' + result.strategy_name;
            card.appendChild(header);
            
            // Add metrics
            const metrics = [
                { name: 'Return', value: (result.return * 100).toFixed(2) + '%' },
                { name: 'Sharpe Ratio', value: result.sharpe.toFixed(2) },
                { name: 'Win Rate', value: (result.win_rate * 100).toFixed(2) + '%' },
                { name: 'Max Drawdown', value: (result.max_drawdown * 100).toFixed(2) + '%' }
            ];
            
            metrics.forEach(metric => {
                const metricDiv = document.createElement('div');
                metricDiv.className = 'metric';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'metric-name';
                nameSpan.textContent = metric.name;
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = metric.value;
                
                metricDiv.appendChild(nameSpan);
                metricDiv.appendChild(valueSpan);
                card.appendChild(metricDiv);
            });
            
            // Add chart if available
            if (result.chart_url) {
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                
                const chartImg = document.createElement('img');
                chartImg.src = result.chart_url;
                chartImg.alt = 'Strategy Performance Chart';
                
                chartContainer.appendChild(chartImg);
                card.appendChild(chartContainer);
            }
            
            // Add warning if present
            if (result.warning) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'error-message';
                warningDiv.textContent = result.warning;
                card.appendChild(warningDiv);
            }
            
            // Add note if present
            if (result.note) {
                const noteDiv = document.createElement('div');
                noteDiv.className = 'note';
                noteDiv.textContent = result.note;
                card.appendChild(noteDiv);
            }
            
            // Add to results container
            resultsContainer.appendChild(card);
            
            // Scroll to results
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Initialize price chart
        function initPriceChart() {
            fetch('/api/price-history')
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('price-chart');
                    if (!ctx) return;
                    
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.dates,
                            datasets: [{
                                label: 'Copper Price',
                                data: data.prices,
                                borderColor: '#2980b9',
                                backgroundColor: 'rgba(41, 128, 185, 0.1)',
                                tension: 0.1,
                                pointRadius: 0,
                                pointHoverRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        maxTicksLimit: 10
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Price: $${context.raw.toFixed(2)}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading price data:', error);
                    showStatus('Error loading price data', 'error');
                });
        }

        // Initialize status checker
        function initStatusChecker() {
            // Check status every 30 seconds
            checkStatus();
            setInterval(checkStatus, 30000);
        }

        // Check system status
        function checkStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('status');
                    if (data.status === 'ok') {
                        statusElement.className = 'status';
                        statusElement.textContent = 'System Online';
                        
                        // Hide after 3 seconds
                        setTimeout(() => {
                            statusElement.classList.add('hidden');
                        }, 3000);
                    } else {
                        statusElement.className = 'status error';
                        statusElement.textContent = 'System Error';
                        statusElement.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const statusElement = document.getElementById('status');
                    statusElement.className = 'status error';
                    statusElement.textContent = 'Connection Error';
                    statusElement.classList.remove('hidden');
                });
        }

        // Show status message
        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = type === 'error' ? 'status error' : 'status';
            statusElement.classList.remove('hidden');
            
            // Hide after 3 seconds
            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
